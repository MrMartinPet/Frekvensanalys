<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Frekvensanalys Lagledare</title>
<style>
  :root{
    --bg:#0b0c10; /* dark frame */
    --card:#ffffff;
    --muted:#efefef;
    --text:#111;
    --accent:#3a6ff8;
    --pill:#6b7280;
    --good:#10b981; /* green */
    --warn:#f59e0b; /* amber */
    --bad:#ef4444;  /* red */
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  body{margin:0;background:#f5f7fb;color:var(--text);font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
  .wrap{max-width:560px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column;}
  .topbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, #fff, #fff0);padding:12px 14px 8px;border-bottom:1px solid #eef1f7;backdrop-filter:saturate(1.2) blur(6px);} 
  h1{font-size:18px;margin:0 0 6px;font-weight:700}

  /* CARDS */
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 24px rgba(20,22,30,.06);padding:12px;margin:10px 14px;}
  .row{display:flex;gap:10px}
  .col{flex:1}
  input, select{width:100%;padding:14px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px;background:#fff}
  .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:14px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:600;font-size:16px}
  .ghost{background:#111827;color:#fff}
  .muted{background:#e5e7eb;color:#111}
  .chip{background:#eef2ff;color:#1f2937;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600}

  /* SETUP */
  .sectionTitle{font-weight:700;font-size:15px;margin:6px 14px}
  details{background:#ffffff;border-radius:14px;margin:8px 14px;overflow:hidden;border:1px solid #eff1f6}
  summary{list-style:none;padding:14px 16px;font-weight:700;display:flex;align-items:center;gap:8px}
  summary::-webkit-details-marker{display:none}
  .activityRow{display:flex;gap:8px;align-items:center;padding:10px 14px;border-top:1px solid #f1f3f8}
  .activityRow input{flex:1}
  .addRow{padding:12px 14px;border-top:1px dashed #e5e7eb;display:flex;gap:8px}

  /* ANALYSIS */
  .nowBar{display:grid;grid-template-columns:1fr 120px;gap:10px;align-items:stretch}
  .pill{background:#6b7280;color:#fff;border-radius:16px;padding:18px;display:flex;align-items:center;justify-content:center;text-align:center;font-size:18px;font-weight:700;min-height:72px}
  .timer{background:#374151;color:#fff;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .rowBtn{display:grid;grid-template-columns:1fr 100px;gap:10px;align-items:center}
  .btnAct{padding:14px;border:none;border-radius:12px;background:#f5e1bf;font-weight:700;font-size:16px}
  .badge{padding:12px;border-radius:12px;background:#f1f5f9;text-align:center;font-weight:700}
  .fab{position:fixed;inset:auto 16px 16px auto;background:var(--accent);color:#fff;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 10px 20px rgba(58,111,248,.35);border:none}
  .toolbar{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}

  /* SUMMARY */
  canvas{max-width:100%;}

</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>Frekvensanalys</h1>
    <div class="chip" id="sessionChip" hidden></div>
  </div>

  <!-- SETUP SCREEN -->
  <section id="setup">
    <div class="card">
      <div class="row">
        <div class="col"><input id="leader" placeholder="Lagledare"></div>
        <div class="col"><input id="flow" placeholder="Flöde"></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="col"><input id="date" type="date"></div>
        <div class="col"><button class="btn" onclick="startSession()">Starta analys</button></div>
      </div>
    </div>

    <div class="sectionTitle">Kategorier & aktiviteter</div>
    <div id="editor"></div>
    <div class="card">
      <div class="row">
        <input id="newCatName" placeholder="Ny kategori">
        <button class="btn muted" onclick="addCategory()">Lägg till kategori</button>
      </div>
    </div>
  </section>

  <!-- ANALYSIS SCREEN -->
  <section id="analysis" hidden>
    <div class="card">
      <div class="nowBar">
        <div class="pill" id="currentAct">–</div>
        <div class="timer" id="liveTimer">00:00:00</div>
      </div>
      <div class="toolbar">
        <button class="btn muted" onclick="pauseActivity()" id="pauseBtn">Pausa aktivitet</button>
        <button class="btn ghost" onclick="finishSession()">Avsluta</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:8px">
        <input id="adHocName" placeholder="Lägg till aktivitet…">
        <select id="adHocCat"></select>
        <button class="btn" style="width:auto;padding:0 16px" onclick="addActivityDynamic()">+ Lägg till</button>
      </div>
    </div>

    <div class="list" id="actList"></div>

    <button class="fab" title="Ny aktivitet" onclick="document.getElementById('adHocName').focus()">＋</button>
  </section>

  <!-- SUMMARY SCREEN -->
  <section id="summary" hidden>
    <div class="card">
      <div class="row">
        <div class="col"><button class="btn muted" onclick="downloadCSV()">Exportera CSV</button></div>
        <div class="col"><button class="btn" onclick="window.location.reload()">Ny analys</button></div>
      </div>
    </div>
    <div class="card">
      <canvas id="pie"></canvas>
    </div>
    <div id="totals" class="list"></div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ---- DATA MODEL ----
const model = {
  header:{ leader:"", flow:"", date:"" },
  cats:[
    {name:"Produktionsplanering", acts:["Planering formning","Planering limning","Planering fräsning"]},
    {name:"Möten", acts:["Skiftstartmöte","Morgomöte","Övrigt möte","Personalplaneringsmöte"]},
    {name:"Problem", acts:["Kvalitetsproblem","Materialproblem","Verktygsproblem"]},
    {name:"Logistik", acts:["Material till fräs","Material till formning","Verktyg till utruta"]}
  ],
  totals:{}, // name -> seconds
  sessionStart:0,
  sessionTicker:0,
  active:null,
  activeStart:0,
  paused:false,
  history:[]
};

// ---- SETUP EDITOR ----
function renderEditor(){
  const host = document.getElementById('editor');
  host.innerHTML = '';
  model.cats.forEach((c,ci)=>{
    const det = document.createElement('details');
    det.open = false; // collapsed by default for mobile scroll
    det.innerHTML = `<summary>${c.name}</summary>`;

    c.acts.forEach((a,ai)=>{
      const row = document.createElement('div');
      row.className='activityRow';
      row.innerHTML = `<input value="${a}" onchange="renameActivity(${ci},${ai},this.value)">\
                       <button class='btn muted' style='width:auto' onclick='delActivity(${ci},${ai})'>Ta bort</button>`;
      det.appendChild(row);
    });

    const add = document.createElement('div');
    add.className='addRow';
    add.innerHTML = `<input placeholder='Ny aktivitet'>\
                     <button class='btn' style='width:auto' onclick='pushActivity(${ci}, this.previousElementSibling.value)'>+ Lägg till</button>`;
    det.appendChild(add);

    const ren = document.createElement('div');
    ren.className='addRow';
    ren.innerHTML = `<input value='${c.name}' onchange='renameCategory(${ci}, this.value)'>`;
    det.appendChild(ren);

    host.appendChild(det);
  });
  // fill category select for ad-hoc add
  const sel = document.getElementById('adHocCat');
  sel.innerHTML = model.cats.map((c,i)=>`<option value='${i}'>${c.name}</option>`).join('');
}

function addCategory(){
  const n = document.getElementById('newCatName').value.trim();
  if(!n) return; model.cats.push({name:n, acts:[]});
  document.getElementById('newCatName').value='';
  renderEditor();
}
function renameCategory(ci, val){ model.cats[ci].name = val; renderEditor(); }
function renameActivity(ci, ai, val){ model.cats[ci].acts[ai] = val; renderEditor(); }
function delActivity(ci, ai){ model.cats[ci].acts.splice(ai,1); renderEditor(); }
function pushActivity(ci, name){ if(!name) return; model.cats[ci].acts.push(name); renderEditor(); }

// ---- SESSION ----
function startSession(){
  model.header.leader = document.getElementById('leader').value.trim();
  model.header.flow = document.getElementById('flow').value.trim();
  model.header.date = document.getElementById('date').value;

  // Prepare totals
  model.cats.forEach(c=>c.acts.forEach(a=>model.totals[a]=0));

  // Start session clocks
  model.sessionStart = performance.now();
  model.sessionTicker = requestAnimationFrame(tickSession);

  // Build activity list UI
  renderActList();

  // UI switches
  document.getElementById('setup').hidden = true;
  document.getElementById('analysis').hidden = false;
  const chip = document.getElementById('sessionChip');
  chip.hidden = false; chip.textContent = `${model.header.leader || 'Lagledare'} · ${model.header.flow || 'Flöde'} · ${new Date().toLocaleDateString('sv-SE')}`;
}

function renderActList(){
  const host = document.getElementById('actList');
  host.innerHTML = '';
  // flatted list in category order
  model.cats.forEach(c=>{
    c.acts.forEach(a=>{
      const row = document.createElement('div');
      row.className='rowBtn';
      row.innerHTML = `<button class='btnAct' onclick='selectActivity("${a.replaceAll("\"","&quot;")}")'>${a}</button>\
                       <div class='badge' id='sum_${hash(a)}'>00:00:00</div>`;
      host.appendChild(row);
    })
  })
}

function hash(s){
  let h=0; for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0} return `h${Math.abs(h)}`;
}

function selectActivity(name){
  // Close previous seamlessly using high-res perf clock
  const now = performance.now();
  if(model.active){
    const elapsed = (now - model.activeStart)/1000; // seconds
    model.totals[model.active] = (model.totals[model.active]||0) + elapsed;
    model.history.push({act:model.active, start:model.activeStart, end:now});
  }
  model.active = name;
  model.activeStart = now; // zero the live timer visual
  model.paused = false;
  document.getElementById('currentAct').textContent = name;
  updateLiveTimer(0);
}

function pauseActivity(){
  if(!model.active) return; // nothing to pause
  const now = performance.now();
  const elapsed = (now - model.activeStart)/1000;
  model.totals[model.active] = (model.totals[model.active]||0) + elapsed;
  model.history.push({act:model.active, start:model.activeStart, end:now});
  model.active = null; // no active, user can resume by clicking again (continues sum)
  model.paused = true;
  document.getElementById('currentAct').textContent = 'Pausad';
  updateLiveTimer(0);
}

function addActivityDynamic(){
  const name = document.getElementById('adHocName').value.trim();
  const catIndex = +document.getElementById('adHocCat').value;
  if(!name) return;
  model.cats[catIndex].acts.push(name);
  model.totals[name]=0;
  renderActList();
  document.getElementById('adHocName').value='';
}

// Live session and activity timers (session total never pauses)
function tickSession(){
  // live activity timer
  if(model.active){
    const diff = (performance.now() - model.activeStart)/1000;
    updateLiveTimer(diff);
  }
  // update per-activity badges every second boundary to keep smooth
  updateBadges();
  model.sessionTicker = requestAnimationFrame(tickSession);
}

function updateLiveTimer(sec){
  document.getElementById('liveTimer').textContent = fmt(sec);
}

function updateBadges(){
  // compute totals + any running segment preview
  const preview = {...model.totals};
  if(model.active){
    const extra = (performance.now() - model.activeStart)/1000;
    preview[model.active] = (preview[model.active]||0)+extra;
  }
  // paint
  Object.entries(preview).forEach(([name,secs])=>{
    const el = document.getElementById('sum_'+hash(name));
    if(el) el.textContent = fmt(secs);
  });
}

function fmt(s){
  s = Math.max(0, s|0); // integer seconds
  const h=String(Math.floor(s/3600)).padStart(2,'0');
  const m=String(Math.floor((s%3600)/60)).padStart(2,'0');
  const sec=String(s%60).padStart(2,'0');
  return `${h}:${m}:${sec}`;
}

function finishSession(){
  // close running seamlessly
  if(model.active){
    const now = performance.now();
    const elapsed = (now - model.activeStart)/1000;
    model.totals[model.active] = (model.totals[model.active]||0) + elapsed;
    model.history.push({act:model.active, start:model.activeStart, end:now});
    model.active = null;
  }
  cancelAnimationFrame(model.sessionTicker);

  // Summary UI
  document.getElementById('analysis').hidden = true;
  document.getElementById('summary').hidden = false;
  renderSummary();
}

function renderSummary(){
  const labels = Object.keys(model.totals);
  const data = labels.map(k=>Math.round(model.totals[k]));
  const ctx = document.getElementById('pie');
  new Chart(ctx,{ type:'pie', data:{ labels, datasets:[{ data }] }, options:{ plugins:{ legend:{ position:'bottom' } } } });

  const list = document.getElementById('totals');
  list.innerHTML = labels.filter(l=>model.totals[l]>0).map(l=>`<div class='rowBtn'><div class='btnAct' style='background:#eef2ff'>${l}</div><div class='badge'>${fmt(model.totals[l])}</div></div>`).join('');
}

function downloadCSV(){
  // Export history with header; convert perf.now to wall clock relative to now
  const t0 = Date.now() - (performance.now() - model.sessionStart);
  const rows = [
    ["Lagledare", model.header.leader],
    ["Flöde", model.header.flow],
    ["Datum", model.header.date || new Date(t0).toLocaleDateString('sv-SE')],
    ["\n"],
    ["Aktivitet","Start","Slut","Sekunder"],
  ];
  model.history.forEach(h=>{
    const start = new Date(t0 + (h.start - model.sessionStart)).toISOString();
    const end   = new Date(t0 + (h.end   - model.sessionStart)).toISOString();
    rows.push([h.act, start, end, ((h.end-h.start)/1000).toFixed(0)]);
  });
  rows.push(["\n"],["SUMMA"], ...Object.entries(model.totals).map(([k,v])=>[k,'','',Math.round(v)]));
  const csv = rows.map(r=>r.join(';')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'frekvensanalys.csv';
  a.click();
}

// init
renderEditor();
</script>
</body>
</html>
