<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Frekvensanalys ‚Äì Lagledare</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />

<style>
  :root{
    --bg:#f3f4fb;
    --card:#ffffff;
    --border:#e1e4f2;
    --text:#111827;
    --muted:#6b7280;
    --accent:#2563eb;
    --good:#16a34a;
    --warn:#fb923c;
    --warnbg:#ffedd5;
    --warntext:#7c2d12;
    --shadow:0 10px 24px rgba(15,23,42,.04);
    --radius:16px;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    overscroll-behavior-y:none;
  }
  .wrap{max-width:560px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;margin:12px 14px}
  .row{display:flex;gap:10px}
  .col{flex:1}
  input,select{width:100%;padding:12px 11px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:15px}
  .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:12px 10px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:800;font-size:15px;cursor:pointer}
  .btn.secondary{background:#111827}
  .btn.ghost{background:#e5e7eb;color:#111827}
  .btn.small{padding:9px 10px;font-size:13px;width:auto}
  .sectionTitle{font-weight:900;font-size:15px;margin:8px 14px}
  .fieldLabel{display:block;font-size:12px;font-weight:700;color:var(--muted);margin:0 0 4px 2px}
  .chip{
    display:inline-flex;align-items:center;margin-top:4px;padding:4px 9px;border-radius:999px;
    background:#e0edff;font-weight:700;font-size:11px;color:#1f2933
  }

  .analysisHeader{position:sticky;top:0;z-index:25;background:var(--bg);padding:4px 0}
  .analysisHeaderInner{margin:4px 14px 4px 14px;padding:8px 10px 10px 10px;border-radius:18px}
  .headerTopRow{
    display:grid;grid-template-columns:1.3fr 1fr;gap:8px;align-items:center;margin-bottom:6px
  }
  .headerTitle h2{margin:0;font-size:17px;font-weight:900}
  .headerActions{display:flex;justify-content:flex-end;align-items:center;gap:6px;flex-wrap:wrap}
  .headerEnd{padding:8px 10px;font-size:13px;white-space:nowrap}
  .iconBtn{
    width:36px;height:36px;border-radius:999px;border:none;background:#e5e7eb;
    display:inline-flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer
  }

  .headerMiddleRow{display:grid;grid-template-columns:1.4fr 1fr;gap:6px;margin-bottom:6px}
  .currentActCard{
    border-radius:14px;border:2px solid var(--warn);background:var(--warnbg);color:var(--warntext);
    padding:8px 10px;font-weight:900;font-size:15px;min-height:52px;display:flex;align-items:center
  }
  .timerBlock{display:flex;flex-direction:column;gap:6px}
  .timer{
    border-radius:14px;padding:6px 8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:900
  }
  .timerLabel{font-size:10px;opacity:.9;letter-spacing:.06em;text-transform:uppercase}
  .timerValue{font-size:16px;margin-top:2px}
  .timer.timerCurrent{background:linear-gradient(135deg,#22c55e,#16a34a);color:#ecfdf5;box-shadow:0 0 0 1px rgba(21,128,61,.4)}
  .timer.timerSession{background:linear-gradient(135deg,#38bdf8,#2563eb);color:#eff6ff;box-shadow:0 0 0 1px rgba(37,99,235,.4)}

  .catTabs{
    margin-top:4px;padding:6px;border-radius:12px;border:1px solid var(--border);background:#ffffff;
    display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:6px
  }
  .catTabBtn{
    width:100%;padding:6px 8px;border-radius:999px;border:1px solid var(--border);
    background:#f1f5f9;font-size:12px;font-weight:900;letter-spacing:0.06em;text-transform:uppercase;cursor:pointer
  }
  .catTabBtn.active{background:var(--warnbg);color:var(--warntext);border-color:var(--warn)}
  .list{display:flex;flex-direction:column;gap:8px;margin:6px 0 80px 0}
  .subBlock{margin:10px 14px 12px 14px;padding:10px 12px 12px 12px;border-radius:14px;border:1px solid var(--border);background:#ffffff}
  .subBlockTitle{margin:0 0 6px 2px;font-weight:900;font-size:16px;color:#111827}
  .actGrid{margin-top:4px;display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:8px}
  .actCard{display:flex;align-items:center;gap:8px}
  .btnAct{
    padding:12px 14px;border-radius:999px;border:none;background:#f9fafb;box-shadow:0 1px 3px rgba(15,23,42,.08);
    font-weight:800;font-size:13px;text-align:left;line-height:1.3;cursor:pointer;flex:1;
    transition:box-shadow .15s ease, transform .1s ease, background-color .15s ease
  }
  .btnAct:active{transform:scale(0.98);box-shadow:0 0 0 rgba(0,0,0,0);background:#e5e7eb}
  .badge{
    padding:7px 6px;border-radius:10px;background:#eef2ff;text-align:center;font-weight:900;font-size:12px;min-width:70px
  }
  .btnAct.activeAct{background:var(--warnbg)!important;color:var(--warntext)!important;border:2px solid var(--warn)!important;box-shadow:0 0 0 rgba(0,0,0,0)!important}
  .badge.activeAct{background:var(--warntext)!important;color:#ffffff!important}

  .summaryToggleRow{display:flex;gap:8px;margin-bottom:8px}
  .chipToggle{
    flex:1;padding:7px 8px;border-radius:999px;border:1px solid var(--border);
    background:#f9fafb;font-size:13px;text-align:center;cursor:pointer;font-weight:800
  }
  .chipToggle.active{background:#2563eb;color:#ffffff;border-color:#2563eb}
  canvas{max-width:100%}

  .notice{
    font-size:13px;color:#991b1b;background:#fee2e2;border:1px solid #fecaca;border-radius:12px;padding:10px 12px;margin:12px 14px
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">

  <!-- SETUP -->
  <section id="setup">
    <div class="card">
      <div class="row">
        <div class="col"><input id="leader" placeholder="Lagledare"></div>
        <div class="col"><input id="flow" placeholder="Fl√∂de"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label class="fieldLabel" for="date">Datum f√∂r analys</label>
          <input id="date" type="date">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col">
          <button class="btn" id="startBtn" type="button">Starta analys</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle" style="margin-top:0;">Kategorier (fr√•n Excel)</div>
      <div id="setupCatTabs" class="catTabs"></div>
    </div>

    <div id="setupActList" class="list"></div>
    <div id="setupNotice" class="notice" hidden></div>
  </section>

  <!-- ANALYS -->
  <section id="analysis" hidden>
    <div class="analysisHeader">
      <div class="card analysisHeaderInner">

        <div class="headerTopRow">
          <div class="headerTitle">
            <h2>Frekvensanalys</h2>
            <div id="sessionChip" class="chip" hidden></div>
          </div>
          <div class="headerActions">
            <button class="iconBtn" id="saveBtn" type="button" title="Spara nu">üíæ</button>
            <button class="iconBtn" id="undoBtn" type="button" title="√Öngra senaste">‚Ü©Ô∏è</button>
            <button class="iconBtn" id="pauseBtn" type="button" title="Pausa/Forts√§tt">‚è∏Ô∏è</button>
            <button class="btn secondary headerEnd" id="finishBtn" type="button">Avsluta</button>
          </div>
        </div>

        <div class="headerMiddleRow">
          <div class="currentActCard" id="currentAct">‚Äì</div>
          <div class="timerBlock">
            <div class="timer timerCurrent">
              <span class="timerLabel">Aktivitet</span>
              <span class="timerValue" id="liveTimer">00:00:00</span>
            </div>
            <div class="timer timerSession">
              <span class="timerLabel">Total analys</span>
              <span class="timerValue" id="sessionTimer">00:00:00</span>
            </div>
          </div>
        </div>

        <div id="catTabs" class="catTabs"></div>
      </div>
    </div>

    <div id="actList" class="list"></div>
  </section>

  <!-- SUMMARY -->
  <section id="summary" hidden>
    <div class="card">
      <div class="row">
        <div class="col"><button class="btn ghost" id="exportBtn" type="button">Exportera till Excel</button></div>
        <div class="col"><button class="btn" id="newBtn" type="button">Ny analys</button></div>
      </div>
    </div>

    <div class="card" id="summaryTotals"></div>

    <div class="card">
      <div class="summaryToggleRow">
        <button id="toggleCat" class="chipToggle active" type="button">Visa per huvudkategori</button>
        <button id="toggleSub" class="chipToggle" type="button">Visa per underkategori</button>
      </div>
      <canvas id="pie"></canvas>
    </div>

    <div class="card"><div id="totals" class="list"></div></div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/**
 * NY VERSION (en fil):
 * - H√§mtar "frekvensanalys_kategorier.xlsx" (GitHub Pages)
 * - St√∂djer tv√• kolumner:
 *    Kategori | Underkategori
 *   (tolerant: andra kolumnen kan ocks√• heta "Aktivitet")
 * - Om en tredje kolumn "Aktivitet" finns st√∂ds √§ven:
 *    Kategori | Underkategori | Aktivitet
 * - Inga inline onclick (stabilare)
 * - Uppdaterar UI med setInterval (sn√§llare prestanda)
 */

const EXCEL_FILE = "frekvensanalys_kategorier.xlsx";

const categoryColors = {
  "Logistik": "#fff3e8",
  "Planering": "#e8f0ff",
  "Problem": "#fff9db",
  "M√∂ten": "#eaf7e8",
  "√ñvrigt": "#f5e0ff"
};

const model = {
  header:{leader:"",flow:"",date:""},
  tree:[],
  actMeta:{},
  totals:{},
  history:[],
  selectedCatIndex:0,
  sessionStart:0,
  active:null,
  activeStart:0,
  paused:false,
  pausedMs:0,
  pauseStart:0,
  tickHandle:null,
  chartMode:"category",
  chartInstance:null
};

// ---------- Excel -> tree ----------
async function loadStructureFromExcel(){
  const res = await fetch(EXCEL_FILE, { cache:"no-store" });
  if(!res.ok) throw new Error("Kunde inte h√§mta "+EXCEL_FILE);

  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf, { type:"array" });
  const sheetName = wb.SheetNames[0];
  const sheet = wb.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(sheet, { header:1 });

  const header = (rows[0] || []).map(h => (h||"").toString().trim());
  const idxCat = header.indexOf("Kategori");
  const idxSub = header.indexOf("Underkategori");
  const idxAct = header.indexOf("Aktivitet");

  if(idxCat === -1) throw new Error("Filen m√•ste ha rubriken: Kategori");

  const treeMap = new Map();
  const ensureCat = (name) => {
    if(!treeMap.has(name)){
      treeMap.set(name, {
        name,
        color: categoryColors[name] || "#ffffff",
        subs: [],
        isOther: name === "√ñvrigt"
      });
    }
    return treeMap.get(name);
  };
  const ensureSub = (cat, subName) => {
    let sub = cat.subs.find(s => s.name === subName);
    if(!sub){
      sub = { name: subName, acts: [] };
      cat.subs.push(sub);
    }
    return sub;
  };

  // FALL A: 3 kolumner (Kategori, Underkategori, Aktivitet)
  if(idxSub !== -1 && idxAct !== -1){
    for(let i=1;i<rows.length;i++){
      const r = rows[i]; if(!r) continue;
      const catName = (r[idxCat]||"").toString().trim();
      const subName = (r[idxSub]||"").toString().trim();
      const actName = (r[idxAct]||"").toString().trim();
      if(!catName || !subName || !actName) continue;

      const cat = ensureCat(catName);
      const sub = ensureSub(cat, subName);
      if(!sub.acts.includes(actName)) sub.acts.push(actName);
    }
    model.tree = Array.from(treeMap.values());
    return;
  }

  // FALL B: 2 kolumner (Kategori + Underkategori) eller (Kategori + Aktivitet)
  const idxSecond = (idxSub !== -1) ? idxSub : idxAct;
  if(idxSecond === -1) throw new Error("Filen m√•ste ha: Kategori + Underkategori (eller Aktivitet)");

  for(let i=1;i<rows.length;i++){
    const r = rows[i]; if(!r) continue;
    const catName = (r[idxCat]||"").toString().trim();
    const second = (r[idxSecond]||"").toString().trim();
    if(!catName || !second) continue;

    // I 2-kolumnsfallet behandlar vi "second" som b√•de:
    // - underkategori (grupp-rubrik)
    // - aktivitet (knappen man klickar p√•)
    const cat = ensureCat(catName);
    const sub = ensureSub(cat, second);
    if(!sub.acts.includes(second)) sub.acts.push(second);
  }

  model.tree = Array.from(treeMap.values());
}

// ---------- Build meta & totals ----------
function buildActMetaAndTotals(){
  model.actMeta = {};
  model.totals = {};
  model.tree.forEach(c=>{
    c.subs.forEach(s=>{
      s.acts.forEach(a=>{
        model.actMeta[a] = { catName:c.name, subName:s.name };
        model.totals[a] = 0;
      });
    });
  });
}

// ---------- UI render ----------
function renderSetupCategoryTabs(){
  const host = document.getElementById("setupCatTabs");
  host.innerHTML = "";
  model.tree.forEach((cat, idx)=>{
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "catTabBtn" + (idx===model.selectedCatIndex ? " active" : "");
    btn.textContent = cat.name.toUpperCase();
    btn.addEventListener("click", ()=>{
      model.selectedCatIndex = idx;
      renderSetupCategoryTabs();
      renderSetupActList();
    });
    host.appendChild(btn);
  });
}

function renderSetupActList(){
  const host = document.getElementById("setupActList");
  host.innerHTML = "";

  const cat = model.tree[model.selectedCatIndex] || model.tree[0];
  if(!cat) return;

  cat.subs.forEach(sub=>{
    const block = document.createElement("div");
    block.className = "subBlock";

    const title = document.createElement("div");
    title.className = "subBlockTitle";
    title.textContent = sub.name;
    block.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "actGrid";

    sub.acts.forEach(act=>{
      const card = document.createElement("div");
      card.className = "actCard";

      const b = document.createElement("button");
      b.type = "button";
      b.className = "btnAct";
      b.textContent = act;
      b.disabled = true;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = "OK";

      card.appendChild(b);
      card.appendChild(badge);
      grid.appendChild(card);
    });

    block.appendChild(grid);
    host.appendChild(block);
  });
}

function renderCategoryTabs(){
  const host = document.getElementById("catTabs");
  host.innerHTML = "";
  model.tree.forEach((cat, idx)=>{
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "catTabBtn" + (idx===model.selectedCatIndex ? " active" : "");
    btn.textContent = cat.name.toUpperCase();
    btn.addEventListener("click", ()=>{
      model.selectedCatIndex = idx;
      renderCategoryTabs();
      renderActList();
      highlightActive();
    });
    host.appendChild(btn);
  });
}

function renderActList(){
  const host = document.getElementById("actList");
  host.innerHTML = "";

  const cat = model.tree[model.selectedCatIndex] || model.tree[0];
  if(!cat) return;

  cat.subs.forEach(sub=>{
    const block = document.createElement("div");
    block.className = "subBlock";

    const title = document.createElement("div");
    title.className = "subBlockTitle";
    title.textContent = sub.name;
    block.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "actGrid";

    sub.acts.forEach(act=>{
      const card = document.createElement("div");
      card.className = "actCard";

      const b = document.createElement("button");
      b.type = "button";
      b.className = "btnAct";
      b.textContent = act;
      b.dataset.act = act;
      b.id = "btn_"+hash(act);
      b.addEventListener("click", ()=>selectActivity(act));

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.id = "sum_"+hash(act);
      badge.textContent = "00:00:00";

      card.appendChild(b);
      card.appendChild(badge);
      grid.appendChild(card);
    });

    block.appendChild(grid);
    host.appendChild(block);
  });

  highlightActive();
}

// ---------- Session ----------
function startSession(){
  model.header.leader = document.getElementById("leader").value.trim();
  model.header.flow = document.getElementById("flow").value.trim();
  model.header.date = document.getElementById("date").value;

  buildActMetaAndTotals();

  model.history = [];
  model.selectedCatIndex = 0;

  model.sessionStart = performance.now();
  model.active = null;
  model.activeStart = 0;
  model.paused = false;
  model.pausedMs = 0;
  model.pauseStart = 0;

  const chip = document.getElementById("sessionChip");
  chip.hidden = false;
  const d = model.header.date ? new Date(model.header.date).toLocaleDateString("sv-SE") : new Date().toLocaleDateString("sv-SE");
  chip.textContent = `${model.header.leader||"Lagledare"} ¬∑ ${model.header.flow||"Fl√∂de"} ¬∑ ${d}`;

  document.getElementById("setup").hidden = true;
  document.getElementById("analysis").hidden = false;

  renderCategoryTabs();
  renderActList();

  setLive(0);
  setSession(0);

  if(model.tickHandle) clearInterval(model.tickHandle);
  model.tickHandle = setInterval(tick, 250);
}

function selectActivity(name){
  if(model.paused){
    // Om pausad: forts√§tt f√∂rst, sedan v√§lj
    togglePause(true);
  }

  const now = performance.now();

  // st√§ng f√∂reg√•ende segment
  if(model.active){
    const dur = now - model.activeStart;
    if(dur > 0){
      model.totals[model.active] = (model.totals[model.active]||0) + dur;
      model.history.push({ act:model.active, start:model.activeStart, end:now });
    }
  }

  model.active = name;
  model.activeStart = now;
  document.getElementById("currentAct").textContent = name;

  setLive(0);
  highlightActive();
}

function togglePause(forceResume=false){
  const now = performance.now();

  if(model.paused || forceResume){
    // RESUME
    if(model.paused){
      model.pausedMs += (now - model.pauseStart);
      model.paused = false;
      model.pauseStart = 0;
      // flytta activeStart fram√•t s√• aktiviteten inte ‚Äúr√§knar paus‚Äù
      if(model.active) model.activeStart = now;
    }
    updatePauseIcon();
    return;
  }

  // PAUSE: st√§ng aktivt segment fram till nu
  if(model.active){
    const dur = now - model.activeStart;
    if(dur > 0){
      model.totals[model.active] = (model.totals[model.active]||0) + dur;
      model.history.push({ act:model.active, start:model.activeStart, end:now });
    }
    model.active = null;
    document.getElementById("currentAct").textContent = "Pausad";
  }

  model.paused = true;
  model.pauseStart = now;
  updatePauseIcon();
  highlightActive();
  setLive(0);
}

function updatePauseIcon(){
  const btn = document.getElementById("pauseBtn");
  btn.textContent = model.paused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
  btn.title = model.paused ? "Forts√§tt" : "Pausa";
}

function undoLast(){
  if(!model.history.length) return;

  // om aktiv: pausa f√∂rst och l√•s senaste segment i history via pause
  if(model.active){
    togglePause(false);
  }

  const last = model.history.pop();
  if(!last) return;

  const ms = Math.max(0, last.end - last.start);
  model.totals[last.act] = Math.max(0, (model.totals[last.act]||0) - ms);

  // UI uppdateras vid n√§sta tick
}

function tick(){
  const now = performance.now();
  const elapsed = now - model.sessionStart - model.pausedMs - (model.paused ? (now - model.pauseStart) : 0);
  setSession(elapsed);

  if(model.active){
    const cur = now - model.activeStart;
    setLive(cur);
  }else{
    setLive(0);
  }

  // preview: totals + active p√•g√•ende
  const preview = { ...model.totals };
  if(model.active){
    preview[model.active] = (preview[model.active]||0) + (now - model.activeStart);
  }

  // Uppdatera bara synliga badges i aktuell kategori
  const cat = model.tree[model.selectedCatIndex] || model.tree[0];
  if(!cat) return;
  cat.subs.forEach(s=>{
    s.acts.forEach(a=>{
      const el = document.getElementById("sum_"+hash(a));
      if(el) el.textContent = fmt(preview[a]||0);
    });
  });
}

function finishSession(){
  if(!confirm("Vill du avsluta analysen? Detta stoppar timern och l√•ser resultatet.")) return;

  if(model.tickHandle) clearInterval(model.tickHandle);
  model.tickHandle = null;

  // st√§ng p√•g√•ende aktivitet om n√•gon (om inte pausad)
  const now = performance.now();
  if(model.active){
    const dur = now - model.activeStart;
    if(dur>0){
      model.totals[model.active] = (model.totals[model.active]||0) + dur;
      model.history.push({ act:model.active, start:model.activeStart, end:now });
    }
    model.active = null;
  }

  document.getElementById("analysis").hidden = true;
  document.getElementById("summary").hidden = false;

  renderSummary();
}

// ---------- Summary ----------
function aggregateByCategory(){
  const res = {};
  for(const [act, ms] of Object.entries(model.totals)){
    const meta = model.actMeta[act]; if(!meta) continue;
    res[meta.catName] = (res[meta.catName]||0) + ms;
  }
  return res;
}
function aggregateBySubcategory(){
  const res = {};
  for(const [act, ms] of Object.entries(model.totals)){
    const meta = model.actMeta[act]; if(!meta) continue;
    const key = `${meta.catName} ‚Äì ${meta.subName}`;
    res[key] = (res[key]||0) + ms;
  }
  return res;
}

function setChartMode(mode){
  model.chartMode = mode;
  document.getElementById("toggleCat").classList.toggle("active", mode==="category");
  document.getElementById("toggleSub").classList.toggle("active", mode==="subcategory");
  renderChart();
}

function renderChart(){
  const dataObj = model.chartMode==="category" ? aggregateByCategory() : aggregateBySubcategory();
  const labels = Object.keys(dataObj);
  const data = labels.map(l => Math.round((dataObj[l]||0)/1000));

  const ctx = document.getElementById("pie").getContext("2d");
  if(model.chartInstance) model.chartInstance.destroy();
  model.chartInstance = new Chart(ctx,{
    type:"pie",
    data:{ labels, datasets:[{ data }] },
    options:{ plugins:{ legend:{ position:"bottom" } } }
  });
}

function renderSummary(){
  renderChart();

  const summaryTotals = document.getElementById("summaryTotals");

  const totalActivitiesMs = Object.values(model.totals).reduce((a,b)=>a+b,0);
  // total analys = faktisk tid (session) baserat p√• timer
  // h√§r anv√§nder vi senaste tick-ber√§knade sessionTimer som ‚Äúsanning‚Äù:
  const sessionText = document.getElementById("sessionTimer").textContent;

  summaryTotals.innerHTML = `
    <div style="font-weight:900;margin-bottom:6px;">Totaler</div>
    <div style="margin-bottom:2px;">Total analys: <b>${sessionText}</b></div>
    <div>Total aktiviteter: <b>${fmt(totalActivitiesMs)}</b></div>
  `;

  const list = document.getElementById("totals");
  const items = Object.entries(model.totals)
    .filter(([,ms]) => ms>0)
    .sort((a,b)=>b[1]-a[1]);

  list.innerHTML = items.map(([name,ms])=>{
    return `<div class="row" style="align-items:center;margin-bottom:4px;">
      <div style="flex:1;font-size:14px;font-weight:800;">${escapeHtml(name)}</div>
      <div class="badge">${fmt(ms)}</div>
    </div>`;
  }).join("");
}

// ---------- Export ----------
function downloadExcel(){
  const wb = XLSX.utils.book_new();
  const base = Date.now() - (performance.now() - model.sessionStart);

  const rows = [];
  rows.push(["Lagledare", model.header.leader]);
  rows.push(["Fl√∂de", model.header.flow]);
  rows.push(["Datum", model.header.date || new Date(base).toLocaleDateString("sv-SE")]);
  rows.push([""]);
  rows.push(["Aktivitet","Start","Slut","Sekunder"]);

  model.history.forEach(h=>{
    rows.push([
      h.act,
      new Date(base + (h.start - model.sessionStart)).toLocaleString("sv-SE"),
      new Date(base + (h.end - model.sessionStart)).toLocaleString("sv-SE"),
      Math.round((h.end - h.start)/1000)
    ]);
  });

  rows.push([""]);
  rows.push(["SUMMA"]);
  Object.entries(model.totals).forEach(([k,vMs])=>{
    rows.push([k, "", "", Math.round(vMs/1000)]);
  });

  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "Detaljer");

  const catAgg = aggregateByCategory();
  const rows2 = [["Kategori","Sekunder"]];
  Object.entries(catAgg).forEach(([k,vMs])=>rows2.push([k, Math.round(vMs/1000)]));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows2), "Kategorier");

  const subAgg = aggregateBySubcategory();
  const rows3 = [["Underkategori","Sekunder"]];
  Object.entries(subAgg).forEach(([k,vMs])=>rows3.push([k, Math.round(vMs/1000)]));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows3), "Underkategorier");

  XLSX.writeFile(wb, "frekvensanalys.xlsx");
}

function confirmNewAnalysis(){
  if(confirm("Vill du starta en ny analys? Tidigare data f√∂rsvinner om du inte exporterat till Excel.")){
    window.location.reload();
  }
}

// ---------- Helpers ----------
function hash(s){
  let h=0;
  for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  return "h"+Math.abs(h);
}
function fmt(ms){
  const sec=Math.max(0,Math.round(ms/1000));
  const h=(""+Math.floor(sec/3600)).padStart(2,"0");
  const m=(""+Math.floor((sec%3600)/60)).padStart(2,"0");
  const s=(""+(sec%60)).padStart(2,"0");
  return `${h}:${m}:${s}`;
}
function setLive(ms){ document.getElementById("liveTimer").textContent = fmt(ms); }
function setSession(ms){ document.getElementById("sessionTimer").textContent = fmt(ms); }

function highlightActive(){
  document.querySelectorAll(".btnAct").forEach(b=>b.classList.remove("activeAct"));
  document.querySelectorAll(".badge").forEach(b=>b.classList.remove("activeAct"));
  if(!model.active) return;

  const id = hash(model.active);
  const btn = document.getElementById("btn_"+id);
  const badge = document.getElementById("sum_"+id);
  if(btn) btn.classList.add("activeAct");
  if(badge) badge.classList.add("activeAct");
}

function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

// ---------- Safety: leaving page ----------
window.addEventListener("beforeunload", (e)=>{
  const analysisVisible = document.getElementById("analysis") && !document.getElementById("analysis").hidden;
  if(analysisVisible){
    const msg = "Du h√•ller p√• att avsluta analysen. All registrerad tid kan f√∂rloras om du l√§mnar sidan.";
    e.preventDefault();
    e.returnValue = msg;
    return msg;
  }
});

// ---------- Wire UI ----------
document.getElementById("startBtn").addEventListener("click", startSession);
document.getElementById("finishBtn").addEventListener("click", finishSession);
document.getElementById("saveBtn").addEventListener("click", downloadExcel);
document.getElementById("exportBtn").addEventListener("click", downloadExcel);
document.getElementById("newBtn").addEventListener("click", confirmNewAnalysis);
document.getElementById("pauseBtn").addEventListener("click", ()=>togglePause(false));
document.getElementById("undoBtn").addEventListener("click", undoLast);
document.getElementById("toggleCat").addEventListener("click", ()=>setChartMode("category"));
document.getElementById("toggleSub").addEventListener("click", ()=>setChartMode("subcategory"));

// ---------- Boot ----------
(async function boot(){
  try{
    await loadStructureFromExcel();
    if(!model.tree.length) throw new Error("Excel l√§stes men gav ingen struktur (inga rader).");
    model.selectedCatIndex = 0;
    renderSetupCategoryTabs();
    renderSetupActList();
  }catch(err){
    console.error(err);
    const n = document.getElementById("setupNotice");
    n.hidden = false;
    n.textContent =
      "Kunde inte l√§sa "+EXCEL_FILE+
      ". Kontrollera att filen ligger i samma GitHub-repo/mapp som index.html och att rubrikerna √§r 'Kategori' + 'Underkategori' (eller 'Aktivitet').";
  }
})();
</script>
</body>
</html>
