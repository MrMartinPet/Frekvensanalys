<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Frekvensanalys – Lagledare</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e6e8ef; --text:#111827; --muted:#6b7280; --accent:#3a6ff8;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:560px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
  .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(#fff,rgba(255,255,255,.9));border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px);}
  .topbar .inner{padding:12px 14px}
  h1{margin:0;font-size:18px}
  .chip{display:inline-block;margin-top:6px;padding:6px 10px;border-radius:999px;background:#eef2ff;font-weight:600;font-size:12px}

  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.04);padding:12px;margin:12px 14px}
  .row{display:flex;gap:10px}
  .col{flex:1}
  input,select{width:100%;padding:14px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:14px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;font-size:16px}
  .btn.secondary{background:#111827}
  .btn.ghost{background:#e5e7eb;color:#111827}
  .btn.small{padding:10px 12px;font-size:14px}
  .sectionTitle{font-weight:800;font-size:15px;margin:8px 14px}

  details{border:1px solid var(--border);border-radius:16px;overflow:hidden;margin:10px 14px;background:#fff}
  summary{list-style:none;padding:10px 14px;font-weight:800;font-size:14px}
  summary::-webkit-details-marker{display:none}
  .subTitle{padding:6px 14px;font-weight:700;color:#111;font-size:13px}
  .subTitle.sub--small{padding-top:4px;padding-bottom:4px;font-weight:600;color:var(--muted);font-size:12px}
  .rowLine{display:flex;gap:8px;align-items:center;padding:10px 14px;border-top:1px solid var(--border)}
  .rowLine input{flex:1}
  .addRow{padding:12px 14px;border-top:1px dashed var(--border);display:flex;gap:8px}

  /* Analysis view */
  .analysisHeader{position:sticky;top:56px;z-index:9;min-height:20vh;background:var(--bg);display:flex;flex-direction:column;justify-content:center}
  .nowBar{display:grid;grid-template-columns:1fr 120px;gap:10px}
  .pill{background:#6b7280;color:#fff;border-radius:16px;padding:18px;display:flex;align-items:center;justify-content:center;text-align:center;font-size:18px;font-weight:800;min-height:76px}
  .timer{background:#374151;color:#fff;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px}
  .toolbar{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .list{display:flex;flex-direction:column;gap:8px;margin-bottom:80px}
  .rowBtn{display:grid;grid-template-columns:1fr 90px;gap:8px;align-items:center;padding:4px 14px}
  .btnAct{padding:10px;border:none;border-radius:10px;background:#f5e1bf;font-weight:700;font-size:14px;text-align:left;line-height:1.2}
  .btnAct.act--small{font-size:13px;padding:8px 10px}
  .btnAct.activeAct{background:#fed7aa;box-shadow:0 0 0 2px rgba(248,113,113,.6);}
  .badge{padding:8px;border-radius:10px;background:#f1f5f9;text-align:center;font-weight:800;font-size:13px}
  .badge.activeAct{background:#111827;color:#fff}
  .fab{position:fixed;inset:auto 16px 16px auto;width:56px;height:56px;border-radius:50%;border:none;background:var(--accent);color:#fff;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 14px 28px rgba(58,111,248,.35)}
  canvas{max-width:100%}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar"><div class="inner">
    <h1>Frekvensanalys</h1>
    <div id="sessionChip" class="chip" hidden></div>
  </div></div>

  <!-- SETUP -->
  <section id="setup">
    <div class="card">
      <div class="row">
        <div class="col"><input id="leader" placeholder="Lagledare"></div>
        <div class="col"><input id="flow" placeholder="Flöde"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><input id="date" type="date"></div>
        <div class="col"><button class="btn" onclick="startSession()">Starta analys</button></div>
      </div>
    </div>

    <div class="sectionTitle">Kategorier, underkategorier & aktiviteter</div>
    <div id="editor"></div>

    <div class="card">
      <div class="row">
        <input id="newCatName" placeholder="Ny kategori">
        <button class="btn ghost" onclick="addCategory()">Lägg till kategori</button>
      </div>
    </div>
  </section>

  <!-- ANALYSIS -->
  <section id="analysis" hidden>
    <div class="card analysisHeader">
      <div class="nowBar">
        <div class="pill" id="currentAct">–</div>
        <div class="timer" id="liveTimer">00:00:00</div>
      </div>
      <div class="toolbar">
        <button id="pauseBtn" class="btn ghost" onclick="pauseActivity()">Pausa aktivitet</button>
        <button class="btn secondary" onclick="finishSession()">Avsluta</button>
      </div>
    </div>

    <!-- Inga ad-hoc-kategorier här längre; endast i Övrigt längst ner -->

    <div id="actList" class="list"></div>
  </section>

  <!-- SUMMARY -->
  <section id="summary" hidden>
    <div class="card">
      <div class="row">
        <div class="col"><button class="btn ghost" onclick="downloadCSV()">Exportera CSV</button></div>
        <div class="col"><button class="btn" onclick="window.location.reload()">Ny analys</button></div>
      </div>
    </div>
    <div class="card"><canvas id="pie"></canvas></div>
    <div class="card"><div id="totals" class="list"></div></div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// DATA – kategori -> underkategori -> aktiviteter
const model = {
  header:{leader:"",flow:"",date:""},
  tree:[
    { // 1. Logistik
      name:"Logistik", color:"#ffe8d9", subs:[
        {name:"Från inruta", acts:[
          "Material till fräslokal","Material till torg","Material till Formning","Verktyg till Limhjul",
          "Verktyg till Fräslokal","Emballage till Fräslokal","Binge till fräslokal","Övrigt in till flöde"]},
        {name:"Från Materialtorg", acts:["Material till LH","Material till Fräs"]},
        {name:"Från Formning", acts:[
          "Material till Frästorg","Material till Limtorg LH","Material till Limtorg Byrå","Material till utruta","Verktyg till utruta"]},
        {name:"Från Fräsning", acts:[
          "Verktyg till Hans","Verktyg till ställage i fräs","Verktyg till utruta","Vinkel till torg",
          "Material till monteringstorg","Tompall till utruta","Verktyg till bäddfräs (ställage)"]},
        {name:"Från Limning", acts:[
          "Verktyg till Laura","Verktyg till vagnsplats golv","Verktyg till utruta","Tompall till utruta",
          "Överblivet material till utruta","Vinkel till torg"]},
        {name:"Från Verktygshiss/Vagnsplats", acts:[
          "Verktyg från Laura till LH","Verktyg från Hans till fräslokal","Verktyg från golvplats till LH"]},
        {name:"Övrigt logistik", acts:[
          "Packlåda till fräs","Tompall/vagn till fräs","Tomvagn till fräs","Ingående komponenter"]}
      ]
    },
    { // 2. Produktionsplanering
      name:"Produktionsplanering", color:"#e8f0ff", subs:[
        {name:"I Monitor", acts:[
          "Planering formning","Planering borrning","Planering limning","Planering fräsning"]},
        {name:"Powerapp", acts:["Beställning i app"]},
        {name:"Excel", acts:["Planering"]},
        {name:"Överlämning", acts:["Förberedelse av Överlämning"]}
      ]
    },
    { // 3. Problem
      name:"Problem", color:"#fff9db", subs:[
        {name:"Problemlösning", acts:[
          "Kvalitetsproblem","Verktygsproblem","Materialproblem","Emballageproblem","Maskinproblem"]}
      ]
    },
    { // 4. Möten
      name:"Möten", color:"#eaf7e8", subs:[
        {name:"Planerat möte", acts:[
          "Skiftstartsmöte","Morgomöte","Övrigt möte","Övrig Personalplanering",
          "Personalplaneringsmöte","Skiftöverlämning","QROC","QRSC"]}
      ]
    },
    { // 5. Övrigt
      name:"Övrigt", color:"#f5e0ff", isOther:true, subs:[
        {name:"Övrigt", acts:["Gång","Rast","Ingenting"]}
      ]
    }
  ],
  totals:{}, // aktivitet -> sekunder
  sessionStart:0, sessionRAF:0,
  active:null, activeStart:0, history:[], paused:false
};

// =========== SETUP EDITOR ==========
function renderEditor(){
  const host = document.getElementById('editor');
  host.innerHTML='';
  model.tree.forEach((cat,ci)=>{
    const d=document.createElement('details');
    d.style.background=cat.color||'#fff';
    d.open=false;
    const s=document.createElement('summary'); s.textContent=cat.name; d.appendChild(s);

    cat.subs.forEach((sub,si)=>{
      const t=document.createElement('div'); t.className='subTitle'; t.textContent=sub.name; d.appendChild(t);
      sub.acts.forEach((act,ai)=>{
        const r=document.createElement('div'); r.className='rowLine';
        r.innerHTML=`<input value="${act}" onchange="renameAct(${ci},${si},${ai},this.value)">`+
          `<button class='btn small ghost' style='width:auto' onclick='delAct(${ci},${si},${ai})'>Ta bort</button>`;
        d.appendChild(r);
      });
      const add=document.createElement('div'); add.className='addRow';
      add.innerHTML=`<input placeholder='Ny aktivitet i ${sub.name}'>`+
        `<button class='btn small' style='width:auto' onclick='pushAct(${ci},${si}, this.previousElementSibling.value)'>+ Lägg till</button>`;
      d.appendChild(add);
    });

    const ren=document.createElement('div'); ren.className='addRow';
    ren.innerHTML=`<input value='${cat.name}' onchange='renameCat(${ci},this.value)'>`;
    d.appendChild(ren);
    host.appendChild(d);
  });
}
function addCategory(){
  const n=document.getElementById('newCatName').value.trim();
  if(!n) return;
  model.tree.push({name:n,color:'#fff',subs:[]});
  document.getElementById('newCatName').value='';
  renderEditor();
}
function renameCat(ci,v){ model.tree[ci].name=v; renderEditor(); }
function renameAct(ci,si,ai,v){ model.tree[ci].subs[si].acts[ai]=v; renderEditor(); }
function delAct(ci,si,ai){ model.tree[ci].subs[si].acts.splice(ai,1); renderEditor(); }
function pushAct(ci,si,name){
  if(!name) return;
  model.tree[ci].subs[si].acts.push(name);
  renderEditor();
}

// =========== ANALYS ==========
function startSession(){
  model.header.leader=document.getElementById('leader').value.trim();
  model.header.flow=document.getElementById('flow').value.trim();
  model.header.date=document.getElementById('date').value;

  // förbered totals
  model.totals={};
  model.tree.forEach(c=>c.subs.forEach(s=>s.acts.forEach(a=>model.totals[a]=0)));

  model.sessionStart=performance.now();
  model.history=[];
  model.active=null;
  model.activeStart=0;

  renderActList();
  document.getElementById('setup').hidden=true;
  document.getElementById('analysis').hidden=false;

  const chip=document.getElementById('sessionChip');
  chip.hidden=false;
  chip.textContent=`${model.header.leader||'Lagledare'} · ${model.header.flow||'Flöde'} · ${new Date().toLocaleDateString('sv-SE')}`;

  tick();
}

// Grupperad lista under analys
function renderActList(){
  const host=document.getElementById('actList');
  host.innerHTML='';

  model.tree.forEach(cat=>{
    const det=document.createElement('details');
    det.open=true;
    det.style.background=cat.color||'#fff';

    const sum=document.createElement('summary');
    sum.textContent=cat.name;
    det.appendChild(sum);

    cat.subs.forEach((sub,subIndex)=>{
      if(!sub.acts || !sub.acts.length) return;

      const subTitle=document.createElement('div');
      subTitle.className='subTitle sub--small';
      subTitle.textContent=sub.name;
      det.appendChild(subTitle);

      sub.acts.forEach(act=>{
        const row=document.createElement('div');
        row.className='rowBtn';
        const safeAct = act.replaceAll('"',"&quot;");
        row.innerHTML =
          `<button class="btnAct act--small" id="btn_${hash(act)}" data-act="${safeAct}" onclick='selectActivity("${safeAct}")'>${act}</button>`+
          `<div class="badge" id="sum_${hash(act)}">00:00:00</div>`;
        det.appendChild(row);
      });

      // Lägga till nya aktiviteter endast under Övrigt (sista kategorin)
      if(cat.isOther && subIndex === cat.subs.length-1){
        const addRow=document.createElement('div');
        addRow.className='addRow';
        addRow.style.borderTopStyle='solid';
        addRow.innerHTML =
          `<input id="otherNewAct" placeholder="Ny aktivitet i Övrigt">`+
          `<button class="btn small" style="width:auto" onclick="addOtherActivity()">+ Lägg till</button>`;
        det.appendChild(addRow);
      }
    });

    host.appendChild(det);
  });

  highlightActiveRow(); // om man kör render efter att aktivitet redan valts
}

function addOtherActivity(){
  const input=document.getElementById('otherNewAct');
  if(!input) return;
  const name=input.value.trim();
  if(!name) return;

  const otherIdx = model.tree.findIndex(c=>c.isOther);
  if(otherIdx === -1) return;
  const otherCat = model.tree[otherIdx];
  if(!otherCat.subs.length) otherCat.subs.push({name:"Övrigt",acts:[]});
  otherCat.subs[0].acts.push(name);

  // säkerställ totals
  model.totals[name]=0;

  input.value='';
  renderActList();
}

function selectActivity(name){
  const now=performance.now();

  if(model.active){
    const d=(now-model.activeStart)/1000;
    if(d>0){
      model.totals[model.active]=(model.totals[model.active]||0)+d;
      model.history.push({act:model.active,start:model.activeStart,end:now});
    }
  }

  model.active=name;
  model.activeStart=now;
  model.paused=false;
  document.getElementById('currentAct').textContent=name;
  setLive(0);
  highlightActiveRow();
}

function pauseActivity(){
  if(!model.active) return;
  const now=performance.now();
  const d=(now-model.activeStart)/1000;
  if(d>0){
    model.totals[model.active]+=(d>0?d:0);
    model.history.push({act:model.active,start:model.activeStart,end:now});
  }
  model.active=null;
  model.paused=true;
  document.getElementById('currentAct').textContent='Pausad';
  setLive(0);
  highlightActiveRow();
}

function tick(){
  const now = performance.now();

  if(model.active){
    const d=(now-model.activeStart)/1000;
    setLive(d);
  }

  // preview: totals + ev. pågående aktivitet
  const preview={...model.totals};
  if(model.active){
    preview[model.active]=(preview[model.active]||0)+((now-model.activeStart)/1000);
  }

  for(const [k,v] of Object.entries(preview)){
    const el=document.getElementById('sum_'+hash(k));
    if(el){
      // aktiv aktivitets badge sätts längre ner för att matcha huvudtimern
      if(model.active===k){
        el.textContent=document.getElementById('liveTimer').textContent;
      } else {
        el.textContent=fmt(v);
      }
    }
  }

  model.sessionRAF=requestAnimationFrame(tick);
}

function finishSession(){
  if(model.active){
    const now=performance.now();
    const d=(now-model.activeStart)/1000;
    if(d>0){
      model.totals[model.active]+=d;
      model.history.push({act:model.active,start:model.activeStart,end:now});
    }
    model.active=null;
  }
  cancelAnimationFrame(model.sessionRAF);
  document.getElementById('analysis').hidden=true;
  document.getElementById('summary').hidden=false;
  renderSummary();
}

// =========== SUMMARY & EXPORT ==========
function renderSummary(){
  const labels=Object.keys(model.totals);
  const data=labels.map(k=>Math.round(model.totals[k]));
  new Chart(document.getElementById('pie'),{
    type:'pie',
    data:{labels,datasets:[{data}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });

  const list=document.getElementById('totals');
  list.innerHTML=labels
    .filter(l=>model.totals[l]>0)
    .map(l=>`<div class='rowBtn'><div class='btnAct' style='background:#eef2ff'>${l}</div><div class='badge'>${fmt(model.totals[l])}</div></div>`)
    .join('');
}

function downloadCSV(){
  const base=Date.now()-(performance.now()-model.sessionStart);
  const rows=[
    ["Lagledare",model.header.leader],
    ["Flöde",model.header.flow],
    ["Datum",model.header.date||new Date(base).toLocaleDateString('sv-SE')],
    ["\n"],
    ["Aktivitet","Start","Slut","Sekunder"]
  ];
  model.history.forEach(h=>{
    rows.push([
      h.act,
      new Date(base+(h.start-model.sessionStart)).toISOString(),
      new Date(base+(h.end-model.sessionStart)).toISOString(),
      Math.round((h.end-h.start)/1000)
    ]);
  });
  rows.push(["\n"],["SUMMA"],...Object.entries(model.totals).map(([k,v])=>[k,'','',Math.round(v)]));
  const csv=rows.map(r=>r.join(';')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='frekvensanalys.csv';
  a.click();
}

// =========== HELPERS ==========
function hash(s){
  let h=0;
  for(let i=0;i<s.length;i++){
    h=((h<<5)-h)+s.charCodeAt(i);
    h|=0;
  }
  return 'h'+Math.abs(h);
}
function fmt(sec){
  sec=Math.max(0,Math.round(sec));
  const h=(''+Math.floor(sec/3600)).padStart(2,'0');
  const m=(''+Math.floor((sec%3600)/60)).padStart(2,'0');
  const s=(''+(sec%60)).padStart(2,'0');
  return `${h}:${m}:${s}`;
}
function setLive(s){
  document.getElementById('liveTimer').textContent=fmt(s);
}
function highlightActiveRow(){
  // nollställ alla
  document.querySelectorAll('.btnAct').forEach(b=>b.classList.remove('activeAct'));
  document.querySelectorAll('.badge').forEach(b=>b.classList.remove('activeAct'));

  if(!model.active) return;
  const id = hash(model.active);
  const btn=document.getElementById('btn_'+id);
  const badge=document.getElementById('sum_'+id);
  if(btn) btn.classList.add('activeAct');
  if(badge) badge.classList.add('activeAct');
}

// ====== Varning vid uppdatering/stängning under analys ======
window.addEventListener("beforeunload", function (e) {
  const analysisVisible = document.getElementById('analysis') && !document.getElementById('analysis').hidden;
  if (analysisVisible) {
    const msg = "Du håller på att avsluta analysen. All registrerad tid kan förloras om du lämnar sidan.";
    e.preventDefault();
    e.returnValue = msg;
    return msg;
  }
});

// boot
renderEditor();
</script>
</body>
</html>
